"""
FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π.

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
- Currents API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ
- OpenAI API (GPT-4o-mini) –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–π –∏ —Å—Ç–∞—Ç–µ–π

–ê–≤—Ç–æ—Ä: [–í–∞—à–µ –∏–º—è]
–í–µ—Ä—Å–∏—è: 1.0.0
"""

import os
import logging
from typing import Optional, List
from datetime import datetime

# –ó–∞–≥—Ä—É–∂–∞–µ–º .env —Ñ–∞–π–ª (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
try:
    from dotenv import load_dotenv
    load_dotenv()
    print("‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞")
except ImportError:
    pass  # python-dotenv –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

from fastapi import FastAPI, HTTPException, status
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel, Field
import requests
from openai import OpenAI

# ============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø
# ============================================================================

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S"
)
logger = logging.getLogger(__name__)

# ============================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
# ============================================================================

class Settings:
    """
    –ö–ª–∞—Å—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.
    """

    def __init__(self):

        # –ü–æ–ª—É—á–∞–µ–º API –∫–ª—é—á OpenAI –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        self.openai_api_key: str = os.getenv("OPENAI_API_KEY")

        # –ü–æ–ª—É—á–∞–µ–º API –∫–ª—é—á Currents API –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        self.currents_api_key: str = os.getenv("CURRENTS_API_KEY")

        # –ü–æ—Ä—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 8000)
        self.port: int = int(os.getenv("PORT", 8000))

        # URL –¥–ª—è Currents API
        self.currents_api_url: str = "https://api.currentsapi.services/v1/latest-news"

        # –ú–æ–¥–µ–ª—å OpenAI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        self.openai_model: str = "gpt-4o-mini"

        # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        self.max_news_count: int = 5

        # –Ø–∑—ã–∫ –Ω–æ–≤–æ—Å—Ç–µ–π
        self.news_language: str = "en"

    def validate(self) -> None:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.
        –í—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç ValueError, –µ—Å–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ –∫–ª—é—á–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.
        """
        missing_keys = []

        if not self.openai_api_key:
            missing_keys.append("OPENAI_API_KEY")

        if not self.currents_api_key:
            missing_keys.append("CURRENTS_API_KEY")

        if missing_keys:
            error_message = f"–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: {', '.join(missing_keys)}"
            logger.error(error_message)
            raise ValueError(error_message)

        logger.info("‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã")


# –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫
settings = Settings()

# –í–∞–ª–∏–¥–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
settings.validate()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç OpenAI —Å API –∫–ª—é—á–æ–º
openai_client = OpenAI(api_key=settings.openai_api_key)

# ============================================================================
# PYDANTIC –ú–û–î–ï–õ–ò (–°–•–ï–ú–´ –î–ê–ù–ù–´–•)
# ============================================================================

class TopicRequest(BaseModel):
    """
    –ú–æ–¥–µ–ª—å –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.

    Attributes:
        topic: –¢–µ–º–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)
        language: –Ø–∑—ã–∫ –Ω–æ–≤–æ—Å—Ç–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'en')
        max_news: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    """
    topic: str = Field(
        ...,
        min_length=2,
        max_length=200,
        description="–¢–µ–º–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞",
        example="–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç"
    )
    language: Optional[str] = Field(
        default="en",
        description="–Ø–∑—ã–∫ –Ω–æ–≤–æ—Å—Ç–µ–π (en, ru, de, fr –∏ —Ç.–¥.)"
    )
    max_news: Optional[int] = Field(
        default=5,
        ge=1,
        le=10,
        description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"
    )

    class Config:
        json_schema_extra = {
            "example": {
                "topic": "–º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ",
                "language": "en",
                "max_news": 5
            }
        }


class NewsArticle(BaseModel):
    """
    –ú–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ–¥–Ω–æ–π –Ω–æ–≤–æ—Å—Ç–∏.
    """
    title: str = Field(..., description="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–æ—Å—Ç–∏")
    description: Optional[str] = Field(None, description="–û–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏")
    url: Optional[str] = Field(None, description="–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫")
    published: Optional[str] = Field(None, description="–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏")


class GeneratedContent(BaseModel):
    """
    –ú–æ–¥–µ–ª—å –æ—Ç–≤–µ—Ç–∞ —Å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º.

    Attributes:
        title: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏
        meta_description: –ú–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è SEO
        post_content: –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏
        news_sources: –°–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
        generated_at: –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    """
    title: str = Field(..., description="–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏")
    meta_description: str = Field(..., description="–ú–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è SEO")
    post_content: str = Field(..., description="–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏")
    news_sources: List[str] = Field(
        default_factory=list,
        description="–ó–∞–≥–æ–ª–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π"
    )
    generated_at: str = Field(..., description="–í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")
    topic: str = Field(..., description="–ò—Å—Ö–æ–¥–Ω–∞—è —Ç–µ–º–∞")


class HealthResponse(BaseModel):
    """
    –ú–æ–¥–µ–ª—å –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞.
    """
    status: str = Field(..., description="–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞")
    timestamp: str = Field(..., description="–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞")
    version: str = Field(default="1.0.0", description="–í–µ—Ä—Å–∏—è API")


class ErrorResponse(BaseModel):
    """
    –ú–æ–¥–µ–ª—å –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏.
    """
    error: str = Field(..., description="–¢–∏–ø –æ—à–∏–±–∫–∏")
    detail: str = Field(..., description="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏")
    timestamp: str = Field(..., description="–í—Ä–µ–º—è –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –æ—à–∏–±–∫–∏")


# ============================================================================
# –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FASTAPI –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
# ============================================================================

app = FastAPI(
    title="Content Generation API",
    description="""
    ## API –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π

    ### –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
    * üì∞ –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ
    * ‚úçÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    * üìù –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–π –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º
    * üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º GPT-4

    ### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
    1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ POST –∑–∞–ø—Ä–æ—Å –Ω–∞ `/generate-post` —Å —Ç–µ–º–æ–π
    2. –ü–æ–ª—É—á–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏ —Ç–µ–∫—Å—Ç–æ–º —Å—Ç–∞—Ç—å–∏
    """,
    version="1.0.0",
    contact={
        "name": "API Support",
        "email": "support@example.com"
    },
    license_info={
        "name": "MIT License"
    }
)

# –î–æ–±–∞–≤–ª—è–µ–º CORS middleware –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ============================================================================
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# ============================================================================

def get_current_timestamp() -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO 8601.

    Returns:
        str: –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO
    """
    return datetime.now().isoformat()


def get_recent_news(
    topic: str,
    language: str = "en",
    max_count: int = 5
) -> tuple[str, List[str]]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ –∏–∑ Currents API.

    Args:
        topic: –¢–µ–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
        language: –Ø–∑—ã–∫ –Ω–æ–≤–æ—Å—Ç–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'en')
        max_count: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π

    Returns:
        tuple: (—Å—Ç—Ä–æ–∫–∞ —Å –Ω–æ–≤–æ—Å—Ç—è–º–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, —Å–ø–∏—Å–æ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤)

    Raises:
        HTTPException: –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç API
    """
    logger.info(f"üîç –ü–æ–∏—Å–∫ –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ —Ç–µ–º–µ: '{topic}' (—è–∑—ã–∫: {language})")

    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –∫ Currents API
    params = {
        "language": language,
        "keywords": topic,
        "apiKey": settings.currents_api_key
    }

    try:
        # –í—ã–ø–æ–ª–Ω—è–µ–º GET-–∑–∞–ø—Ä–æ—Å –∫ API —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        response = requests.get(
            settings.currents_api_url,
            params=params,
            timeout=30  # –¢–∞–π–º–∞—É—Ç 30 —Å–µ–∫—É–Ω–¥
        )

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
        if response.status_code != 200:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ Currents API: {response.status_code} - {response.text}")
            raise HTTPException(
                status_code=status.HTTP_502_BAD_GATEWAY,
                detail=f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤–æ—Å—Ç–µ–π: {response.text}"
            )

        # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
        data = response.json()
        news_articles = data.get("news", [])

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤–æ—Å—Ç–∏
        if not news_articles:
            logger.warning(f"‚ö†Ô∏è –ù–æ–≤–æ—Å—Ç–∏ –ø–æ —Ç–µ–º–µ '{topic}' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            return "–°–≤–µ–∂–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.", []

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π
        news_articles = news_articles[:max_count]

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
        titles = [article.get("title", "–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞") for article in news_articles]

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –Ω–æ–≤–æ—Å—Ç—è–º–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        news_context = "\n".join([
            f"- {article.get('title', '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞')}: {article.get('description', '')[:200]}"
            for article in news_articles
        ])

        logger.info(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(titles)} –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ —Ç–µ–º–µ '{topic}'")

        return news_context, titles

    except requests.exceptions.Timeout:
        logger.error("‚ùå –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Currents API")
        raise HTTPException(
            status_code=status.HTTP_504_GATEWAY_TIMEOUT,
            detail="–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –Ω–æ–≤–æ—Å—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞"
        )

    except requests.exceptions.RequestException as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Currents API: {str(e)}")
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail=f"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –Ω–æ–≤–æ—Å—Ç–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º: {str(e)}"
        )


def generate_title(topic: str, news_context: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Å—Ç–∞—Ç—å–∏.

    Args:
        topic: –¢–µ–º–∞ —Å—Ç–∞—Ç—å–∏
        news_context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π

    Returns:
        str: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
    """
    logger.info(f"üìù –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–ª—è —Ç–µ–º—ã: '{topic}'")

    prompt = f"""–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –∏ —Ç–æ—á–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Å—Ç–∞—Ç—å–∏ –Ω–∞ —Ç–µ–º—É '{topic}'.

–£—á–∏—Ç—ã–≤–∞–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏:
{news_context}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∑–∞–≥–æ–ª–æ–≤–∫—É:
- –î–ª–∏–Ω–∞: 50-70 —Å–∏–º–≤–æ–ª–æ–≤
- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º –∏ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ
- –î–æ–ª–∂–µ–Ω —è—Å–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å—É—Ç—å —Ç–µ–º—ã
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∏–∫–±–µ–π—Ç
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

–í–µ—Ä–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

    response = openai_client.chat.completions.create(
        model=settings.openai_model,
        messages=[{"role": "user", "content": prompt}],
        max_tokens=100,
        temperature=0.7,
        stop=["\n"]
    )

    title = response.choices[0].message.content.strip()
    # –£–¥–∞–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    title = title.strip('"\'¬´¬ª')

    logger.info(f"‚úÖ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: '{title}'")
    return title


def generate_meta_description(title: str, topic: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ.

    Args:
        title: –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏
        topic: –¢–µ–º–∞ —Å—Ç–∞—Ç—å–∏

    Returns:
        str: –ú–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è SEO
    """
    logger.info(f"üìã –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è: '{title}'")

    prompt = f"""–ù–∞–ø–∏—à–∏—Ç–µ –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Å—Ç–∞—Ç—å–∏.

–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏: {title}
–¢–µ–º–∞: {topic}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –î–ª–∏–Ω–∞: 150-160 —Å–∏–º–≤–æ–ª–æ–≤ (—ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è SEO)
- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º –∏ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º
- –°–æ–¥–µ—Ä–∂–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –ø–æ —Ç–µ–º–µ
- –ü–æ–±—É–∂–¥–∞—Ç—å –∫ –ø—Ä–æ—á—Ç–µ–Ω–∏—é —Å—Ç–∞—Ç—å–∏
- –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

–í–µ—Ä–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫."""

    response = openai_client.chat.completions.create(
        model=settings.openai_model,
        messages=[{"role": "user", "content": prompt}],
        max_tokens=100,
        temperature=0.5
    )

    meta_description = response.choices[0].message.content.strip()
    meta_description = meta_description.strip('"\'¬´¬ª')

    logger.info(f"‚úÖ –ú–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ({len(meta_description)} —Å–∏–º–≤–æ–ª–æ–≤)")
    return meta_description


def generate_article_content(topic: str, title: str, news_context: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏.

    Args:
        topic: –¢–µ–º–∞ —Å—Ç–∞—Ç—å–∏
        title: –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏
        news_context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π

    Returns:
        str: –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏
    """
    logger.info(f"üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å—Ç–∞—Ç—å–∏ –¥–ª—è —Ç–µ–º—ã: '{topic}'")

    prompt = f"""–ù–∞–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—É—é, –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—É—é —Å—Ç–∞—Ç—å—é –Ω–∞ —Ç–µ–º—É '{topic}'.

–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏: {title}

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç:
{news_context}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å—Ç–∞—Ç—å–µ:
1. **–û–±—ä—ë–º**: –º–∏–Ω–∏–º—É–º 1500-2000 —Å–∏–º–≤–æ–ª–æ–≤
2. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
   - –í–≤–µ–¥–µ–Ω–∏–µ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–µ–µ –≤–Ω–∏–º–∞–Ω–∏–µ)
   - 3-4 –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞ —Å –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ## –¥–ª—è –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤)
   - –ó–∞–∫–ª—é—á–µ–Ω–∏–µ —Å –≤—ã–≤–æ–¥–∞–º–∏
3. **–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ**:
   - –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–∏—Ö —Ç—Ä–µ–Ω–¥–æ–≤ –ø–æ —Ç–µ–º–µ
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
   - –≠–∫—Å–ø–µ—Ä—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Å–∏—Ç—É–∞—Ü–∏–∏
   - –ü—Ä–æ–≥–Ω–æ–∑—ã –Ω–∞ –±—É–¥—É—â–µ–µ
4. **–°—Ç–∏–ª—å**:
   - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–π —è–∑—ã–∫
   - –ö–∞–∂–¥—ã–π –∞–±–∑–∞—Ü ‚Äî 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–∫—Ç—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
   - –ò–∑–±–µ–≥–∞–π—Ç–µ –≤–æ–¥—ã –∏ –æ–±—â–∏—Ö —Ñ—Ä–∞–∑
5. **SEO**:
   - –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
   - –ß–∏—Ç–∞–±–µ–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏

–°—Ç–∞—Ç—å—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."""

    response = openai_client.chat.completions.create(
        model=settings.openai_model,
        messages=[{"role": "user", "content": prompt}],
        max_tokens=2000,
        temperature=0.7,
        presence_penalty=0.6,  # –£–º–µ–Ω—å—à–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
        frequency_penalty=0.6  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å–ª–æ–≤
    )

    content = response.choices[0].message.content.strip()

    logger.info(f"‚úÖ –°—Ç–∞—Ç—å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ ({len(content)} —Å–∏–º–≤–æ–ª–æ–≤)")
    return content


def generate_content(topic: str, language: str = "en", max_news: int = 5) -> GeneratedContent:
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å—Ç–∞—Ç—å–∏.

    –ü—Ä–æ—Ü–µ—Å—Å:
    1. –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ —Ç–µ–º–µ
    2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤–æ—Å—Ç–µ–π
    3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏—è
    4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—å–∏

    Args:
        topic: –¢–µ–º–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        language: –Ø–∑—ã–∫ –Ω–æ–≤–æ—Å—Ç–µ–π
        max_news: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π

    Returns:
        GeneratedContent: –û–±—ä–µ–∫—Ç —Å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º

    Raises:
        HTTPException: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    """
    logger.info(f"üöÄ –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —Ç–µ–º—ã: '{topic}'")

    try:
        # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏
        news_context, news_titles = get_recent_news(topic, language, max_news)

        # –®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        title = generate_title(topic, news_context)

        # –®–∞–≥ 3: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ
        meta_description = generate_meta_description(title, topic)

        # –®–∞–≥ 4: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
        post_content = generate_article_content(topic, title, news_context)

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        result = GeneratedContent(
            title=title,
            meta_description=meta_description,
            post_content=post_content,
            news_sources=news_titles,
            generated_at=get_current_timestamp(),
            topic=topic
        )

        logger.info(f"‚úÖ –ö–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ç–µ–º—ã: '{topic}'")
        return result

    except HTTPException:
        # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º HTTP –∏—Å–∫–ª—é—á–µ–Ω–∏—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        raise

    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {str(e)}", exc_info=True)
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {str(e)}"
        )


# ============================================================================
# API –≠–ù–î–ü–û–ò–ù–¢–´
# ============================================================================

@app.get(
    "/",
    response_model=HealthResponse,
    summary="–ö–æ—Ä–Ω–µ–≤–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç",
    description="–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏",
    tags=["Health Check"]
)
async def root() -> HealthResponse:
    """
    –ö–æ—Ä–Ω–µ–≤–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞.

    Returns:
        HealthResponse: –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞ –∏ –≤—Ä–µ–º—è
    """
    return HealthResponse(
        status="running",
        timestamp=get_current_timestamp(),
        version="1.0.0"
    )


@app.get(
    "/health",
    response_model=HealthResponse,
    summary="–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞",
    description="–î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞",
    tags=["Health Check"]
)
async def health_check() -> HealthResponse:
    """
    –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ health checks –≤ Kubernetes/Docker.

    Returns:
        HealthResponse: –î–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
    """
    return HealthResponse(
        status="healthy",
        timestamp=get_current_timestamp(),
        version="1.0.0"
    )


@app.get(
    "/heartbeat",
    summary="Heartbeat —ç–Ω–¥–ø–æ–∏–Ω—Ç",
    description="–ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞",
    tags=["Health Check"]
)
async def heartbeat() -> dict:
    """
    –ü—Ä–æ—Å—Ç–æ–π heartbeat —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.

    Returns:
        dict: –°—Ç–∞—Ç—É—Å OK
    """
    return {"status": "OK", "timestamp": get_current_timestamp()}


@app.post(
    "/generate-post",
    response_model=GeneratedContent,
    summary="–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞",
    description="""
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é —Å—Ç–∞—Ç—å—é –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é —Ç–µ–º—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π.

    –ü—Ä–æ—Ü–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:
    1. –ü–æ–∏—Å–∫ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ —Ç–µ–º–µ —á–µ—Ä–µ–∑ Currents API
    2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    3. –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏—è
    4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—å–∏ —Å —É—á—ë—Ç–æ–º –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
    """,
    tags=["Content Generation"],
    responses={
        200: {
            "description": "–£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞",
            "model": GeneratedContent
        },
        400: {
            "description": "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å",
            "model": ErrorResponse
        },
        500: {
            "description": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
            "model": ErrorResponse
        },
        502: {
            "description": "–û—à–∏–±–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞",
            "model": ErrorResponse
        }
    }
)
async def generate_post_api(request: TopicRequest) -> GeneratedContent:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø–æ—Å—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–µ–º—ã.

    Args:
        request: –û–±—ä–µ–∫—Ç –∑–∞–ø—Ä–æ—Å–∞ —Å —Ç–µ–º–æ–π –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

    Returns:
        GeneratedContent: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç

    Raises:
        HTTPException: –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    """
    logger.info(f"üì® –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–æ–Ω—Ç–µ–Ω—Ç–∞: —Ç–µ–º–∞='{request.topic}'")

    # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–º—ã
    if not request.topic.strip():
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="–¢–µ–º–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π"
        )

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
    result = generate_content(
        topic=request.topic.strip(),
        language=request.language,
        max_news=request.max_news
    )

    return result


@app.get(
    "/news/{topic}",
    summary="–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ —Ç–µ–º–µ",
    description="–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ",
    tags=["News"]
)
async def get_news(
    topic: str,
    language: str = "en",
    limit: int = 5
) -> dict:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ —Ç–µ–º–µ –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.

    Args:
        topic: –¢–µ–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
        language: –Ø–∑—ã–∫ –Ω–æ–≤–æ—Å—Ç–µ–π
        limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π

    Returns:
        dict: –°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
    """
    news_context, titles = get_recent_news(topic, language, min(limit, 10))

    return {
        "topic": topic,
        "language": language,
        "count": len(titles),
        "news": titles,
        "timestamp": get_current_timestamp()
    }


# ============================================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –û–®–ò–ë–û–ö
# ============================================================================

@app.exception_handler(HTTPException)
async def http_exception_handler(request, exc: HTTPException):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ HTTP –∏—Å–∫–ª—é—á–µ–Ω–∏–π.
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –æ–± –æ—à–∏–±–∫–µ –≤ –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.
    """
    return {
        "error": "HTTPException",
        "detail": exc.detail,
        "status_code": exc.status_code,
        "timestamp": get_current_timestamp()
    }


@app.exception_handler(Exception)
async def general_exception_handler(request, exc: Exception):
    """
    –û–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π.
    –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è.
    """
    logger.error(f"‚ùå –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: {str(exc)}", exc_info=True)

    return {
        "error": "InternalServerError",
        "detail": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
        "timestamp": get_current_timestamp()
    }


# ============================================================================
# –°–û–ë–´–¢–ò–Ø –ñ–ò–ó–ù–ï–ù–ù–û–ì–û –¶–ò–ö–õ–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
# ============================================================================

@app.on_event("startup")
async def startup_event():
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π.
    """
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ Content Generation API...")
    logger.info(f"üìå –ü–æ—Ä—Ç: {settings.port}")
    logger.info(f"ü§ñ –ú–æ–¥–µ–ª—å OpenAI: {settings.openai_model}")
    logger.info("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ!")


@app.on_event("shutdown")
async def shutdown_event():
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π.
    """
    logger.info("üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Content Generation API...")
    logger.info("‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!")


# ============================================================================
# –¢–û–ß–ö–ê –í–•–û–î–ê
# ============================================================================

if __name__ == "__main__":
    import uvicorn

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ä—Ç –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º 8000 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    port = settings.port

    logger.info(f"üåê –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É {port}...")

    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é uvicorn
    uvicorn.run(
        "app:app",  # –ü—É—Ç—å –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é (—Ñ–∞–π–ª:–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è)
        host="0.0.0.0",  # –°–ª—É—à–∞–µ–º –≤—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
        port=port,  # –ü–æ—Ä—Ç –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
        reload=False,  # –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
        log_level="info",  # –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        access_log=True  # –í–∫–ª—é—á–∞–µ–º –ª–æ–≥ –¥–æ—Å—Ç—É–ø–∞
    )
